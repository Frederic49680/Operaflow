# üìã R√©sum√© Module BPU - Impl√©mentation Compl√®te

**Date :** 2025-01-21  
**Version :** 1.0  
**Statut :** ‚úÖ Impl√©mentation termin√©e

---

## üéØ Objectif

Cr√©er un module de gestion des affaires BPU (Bordereau de Prix Unitaire) avec saisie guid√©e des r√©alisations, suivi des heures et montants reconnus, et int√©gration dans le journal de maintenance.

---

## üì¶ Ce qui a √©t√© cr√©√©

### 1. Migrations SQL (Base de donn√©es)

#### ‚úÖ Migration 020 : Tables BPU
**Fichier :** `supabase/migrations/020_create_bpu_tables.sql`

**Modifications :**
- Ajout du champ `type_affaire` (ENUM) dans la table `affaires`
- Ajout de champs BPU dans `affaires` :
  - `nb_ressources_ref` (INT)
  - `heures_semaine_ref` (NUMERIC)
  - `periode_debut`, `periode_fin` (DATE)
  - `heures_capacite`, `heures_vendues_total`, `heures_consommes_total`, `montant_reconnu_total` (NUMERIC)
- Cr√©ation de la table `affaire_bpu_lignes` :
  - `code_bpu`, `libelle`, `systeme_elementaire`
  - `quantite`, `unite`, `pu`, `pu_horaire`, `heures_equiv_unitaire`
  - `delivered_qty`, `delivered_hours`, `montant_reconnu`
  - `statut_ligne` (proposee, vendue, annulee)
- Ajout de `is_parapluie_bpu` (BOOL) dans `planning_taches`
- Ajout de `affaire_id` et `bpu_ligne_id` (nullable) dans `maintenance_journal`

**Vues cr√©√©es :**
- `V_BPU_Parapluies_Actifs` : Liste des parapluies BPU actifs avec KPI
- `V_BPU_Lignes_Disponibles` : Lignes BPU disponibles (non sold√©es)
- `V_Affaire_BPU_Suivi` : Suivi global d'une affaire BPU
- `V_Affaire_BPU_Livraisons` : Journal des livraisons/r√©alisations

---

#### ‚úÖ Migration 021 : Fonctions BPU
**Fichier :** `supabase/migrations/021_create_bpu_functions.sql`

**Fonctions cr√©√©es :**
1. `fn_create_bpu_parapluie_task()` : Cr√©e automatiquement la t√¢che parapluie dans le Gantt
2. `fn_bpu_on_realisation_terminee()` : Met √† jour les heures consomm√©es et le montant reconnu quand une r√©alisation est termin√©e
3. `fn_bpu_on_realisation_reportee()` : Log les KPI pour les r√©alisations report√©es
4. `cron_bpu_avancement_weekly()` : Met √† jour le % d'avancement de la t√¢che parapluie (hebdomadaire)
5. `fn_agg_bpu_affaire_totaux()` : Rafra√Æchit les agr√©gats BPU (capacit√©, vendu, consomm√©, reconnu)

**Triggers :**
- `trg_affaire_bpu_lignes_after_insert` : Cr√©e automatiquement la t√¢che parapluie √† la cr√©ation d'une ligne BPU
- `trg_maintenance_journal_bpu_after_update` : D√©clenche les fonctions de mise √† jour selon l'√©tat

---

### 2. Composants React (Frontend)

#### ‚úÖ BPUTaskCard.tsx
**Fichier :** `components/maintenance/BPUTaskCard.tsx`

**Fonctionnalit√©s :**
- Affiche une carte parapluie BPU avec :
  - Capacit√©, Vendu, Consomm√© (heures)
  - Barres de progression (Remplissage et R√©alisation)
  - Montant reconnu (‚Ç¨)
  - Bouton "Nouvelle r√©alisation BPU"
- Ouvre le modal `BPURealizationTile` au clic

---

#### ‚úÖ BPURealizationTile.tsx
**Fichier :** `components/maintenance/BPURealizationTile.tsx`

**Fonctionnalit√©s :**
- Formulaire de saisie guid√©e pour une r√©alisation BPU :
  - Affaire verrouill√©e (non modifiable)
  - Tranche (0-9) obligatoire
  - S√©lection de la ligne BPU (liste d√©roulante)
  - Syst√®me √âl√©mentaire et Type de maintenance (auto-remplis)
  - √âtat (En cours, Termin√©e, Report√©e, Suspendue, Prolong√©e)
  - Heures (pr√©sence, suspension, m√©tal calcul√© automatiquement)
  - Motif (obligatoire si Report√©e)
  - Description
- Validation et envoi vers l'API `/api/bpu/realizations`

---

#### ‚úÖ BPUImportModal.tsx
**Fichier :** `components/affaires/BPUImportModal.tsx`

**Fonctionnalit√©s :**
- Import des lignes BPU depuis un fichier CSV
- Format attendu : `code_bpu;libelle;systeme_elementaire;quantite;unite;pu;pu_horaire;heures_equiv_unitaire`
- Upload de fichier ou collage direct du contenu
- Aper√ßu des lignes avant import
- Validation des en-t√™tes et des donn√©es

---

#### ‚úÖ AffaireBPUOverview.tsx
**Fichier :** `components/affaires/AffaireBPUOverview.tsx`

**Fonctionnalit√©s :**
- Affiche les KPI BPU d'une affaire :
  - 4 cartes : Capacit√©, Vendu, Consomm√©, Reconnu (‚Ç¨)
  - 2 barres de progression : Remplissage et R√©alisation
- Tableau des r√©alisations BPU :
  - Date, Tranche, Syst√®me √âl√©mentaire, Libell√© BPU
  - √âtat, Heures m√©tal, ‚Ç¨ Reconnu, Motif
- Bouton d'export CSV

---

### 3. API Routes (Backend)

#### ‚úÖ /api/bpu/parapluies/route.ts
**M√©thode :** GET  
**Param√®tres :** `site_id` (optionnel)  
**Retour :** Liste des parapluies BPU actifs avec KPI

---

#### ‚úÖ /api/bpu/lignes/route.ts
**M√©thode :** GET  
**Param√®tres :** `affaire_id` (obligatoire)  
**Retour :** Liste des lignes BPU disponibles pour une affaire

---

#### ‚úÖ /api/bpu/realizations/route.ts
**M√©thode :** POST  
**Body :**
```json
{
  "affaire_id": "uuid",
  "tache_id": "uuid",
  "bpu_ligne_id": "uuid",
  "tranche": 0-9,
  "systeme_elementaire": "string",
  "type_maintenance": "string",
  "etat_reel": "En_cours|Termine|Reportee|Suspendue|Prolongee",
  "heures_presence": number,
  "heures_suspension": number,
  "heures_metal": number,
  "motif": "string (si Reportee)",
  "description": "string"
}
```
**Retour :** R√©alisation cr√©√©e avec d√©clenchement automatique des fonctions de mise √† jour

---

#### ‚úÖ /api/bpu/suivi/route.ts
**M√©thode :** GET  
**Param√®tres :** `affaire_id` (obligatoire)  
**Retour :** Suivi global BPU de l'affaire (capacit√©, vendu, consomm√©, reconnu, taux)

---

#### ‚úÖ /api/bpu/livraisons/route.ts
**M√©thode :** GET  
**Param√®tres :** `affaire_id` (obligatoire)  
**Retour :** Liste des livraisons/r√©alisations de l'affaire

---

#### ‚úÖ /api/bpu/import/route.ts
**M√©thode :** POST  
**Body :**
```json
{
  "affaire_id": "uuid",
  "lignes": [
    {
      "code_bpu": "string",
      "libelle": "string",
      "systeme_elementaire": "string",
      "quantite": number,
      "unite": "string",
      "pu": number,
      "pu_horaire": number (optionnel),
      "heures_equiv_unitaire": number (optionnel)
    }
  ]
}
```
**Retour :** Lignes BPU import√©es

---

### 4. Page Maintenance (Int√©gration)

#### ‚úÖ app/maintenance/page.tsx
**Modifications :**
- Ajout de la section "Affaires BPU actives" avant le journal
- Chargement automatique des parapluies BPU via l'API
- Affichage des cartes `BPUTaskCard` pour chaque affaire BPU active
- Section responsive (1 colonne mobile, 2 colonnes desktop)

---

## üîÑ Workflow complet BPU

### 1. Cr√©ation d'une affaire BPU
1. Cr√©er une affaire avec `type_affaire = 'BPU'`
2. Remplir les champs BPU (nb_ressources_ref, heures_semaine_ref, p√©riode)
3. Importer le CSV BPU via `BPUImportModal` ‚Üí cr√©e les lignes dans `affaire_bpu_lignes`
4. Le trigger `trg_affaire_bpu_lignes_after_insert` cr√©e automatiquement la t√¢che parapluie dans le Gantt

### 2. Saisie d'une r√©alisation BPU
1. Aller sur `/maintenance`
2. Voir la carte parapluie de l'affaire BPU
3. Cliquer sur "Nouvelle r√©alisation BPU"
4. Remplir le formulaire guid√© :
   - S√©lectionner la tranche (0-9)
   - Choisir la ligne BPU (liste filtr√©e sur les lignes non sold√©es)
   - V√©rifier le syst√®me √©l√©mentaire et le type (auto-remplis)
   - S√©lectionner l'√©tat
   - Saisir les heures (pr√©sence, suspension, m√©tal calcul√©)
   - Ajouter motif si report√©e
5. Enregistrer ‚Üí POST vers `/api/bpu/realizations`

### 3. Mise √† jour automatique
- Si √©tat = **Termin√©e** ‚Üí d√©clenche `fn_bpu_on_realisation_terminee()` :
  - Ajoute les heures m√©tal au `heures_consommes_total` de l'affaire
  - Met √† jour `delivered_qty` et `montant_reconnu` de la ligne BPU
  - V√©rifie si la ligne est sold√©e (delivered_qty >= quantite)
- Si √©tat = **Report√©e** ‚Üí d√©clenche `fn_bpu_on_realisation_reportee()` :
  - Log KPI, montant reconnu = 0
- Hebdomadaire (lundi 00:05) ‚Üí `cron_bpu_avancement_weekly()` :
  - Met √† jour le % d'avancement de la t√¢che parapluie

### 4. Visualisation
- Sur la fiche affaire : `AffaireBPUOverview` affiche les KPI et le tableau des r√©alisations
- Dans le Gantt : barre parapluie avec progression automatique
- Dans le Dashboard : agr√©gation des KPI BPU

---

## üìä Structure des donn√©es

### Table `affaires` (extensions BPU)
```sql
type_affaire ENUM('BPU', 'Forfait', 'Maintenance', 'Autre')
nb_ressources_ref INT DEFAULT 2
heures_semaine_ref NUMERIC DEFAULT 35
periode_debut DATE
periode_fin DATE
heures_capacite NUMERIC
heures_vendues_total NUMERIC
heures_consommes_total NUMERIC
montant_reconnu_total NUMERIC
```

### Table `affaire_bpu_lignes`
```sql
id UUID PK
affaire_id UUID FK ‚Üí affaires
code_bpu TEXT
libelle TEXT
systeme_elementaire TEXT
quantite NUMERIC
unite TEXT (unit√©, heure, etc.)
pu NUMERIC (prix unitaire)
pu_horaire NUMERIC (optionnel)
heures_equiv_unitaire NUMERIC (optionnel)
delivered_qty NUMERIC DEFAULT 0
delivered_hours NUMERIC DEFAULT 0
montant_reconnu NUMERIC DEFAULT 0
statut_ligne TEXT (proposee, vendue, annulee)
```

### Table `planning_taches` (extension)
```sql
is_parapluie_bpu BOOL DEFAULT false
```

### Table `maintenance_journal` (extensions)
```sql
affaire_id UUID FK ‚Üí affaires (nullable)
bpu_ligne_id UUID FK ‚Üí affaire_bpu_lignes (nullable)
```

---

## üé® UI/UX

### Codes couleur
- **Bleu** : Capacit√©, Parapluie BPU
- **Vert** : Vendu, Montant reconnu, Termin√©e
- **Orange** : Consomm√©, Suspendue
- **Jaune** : Report√©e
- **Violet** : Prolong√©e

### Animations
- Hover sur cartes : elevation, shadow, translate
- Gradients : bleu ‚Üí indigo pour les boutons principaux
- Transitions fluides sur tous les composants

---

## ‚úÖ Crit√®res d'acceptation

- [x] Migrations SQL cr√©√©es et appliqu√©es
- [x] Composants React cr√©√©s (BPUTaskCard, BPURealizationTile, BPUImportModal, AffaireBPUOverview)
- [x] API routes cr√©√©es (parapluies, lignes, realizations, suivi, livraisons, import)
- [x] Page maintenance int√©gr√©e avec section BPU
- [x] Workflow complet : cr√©ation affaire ‚Üí import CSV ‚Üí saisie r√©alisation ‚Üí mise √† jour auto
- [x] Calculs automatiques : heures m√©tal, montant reconnu, % avancement
- [x] Vues SQL pour KPI et reporting
- [x] Triggers automatiques pour cr√©ation t√¢che parapluie et mise √† jour
- [x] UI responsive et moderne

---

## üöÄ Prochaines √©tapes

1. **Tester les migrations SQL** dans Supabase Dashboard
2. **Cr√©er une affaire BPU de test** avec import CSV
3. **Tester la saisie d'une r√©alisation** depuis la page maintenance
4. **V√©rifier les calculs automatiques** (heures, montants, %)
5. **Tester l'affichage** dans le Gantt et sur la fiche affaire

---

## üìù Notes techniques

- **Heures m√©tal** = max(0, heures_presence - heures_suspension)
- **Taux de remplissage** = (heures_consommes / heures_capacite) √ó 100
- **Taux de r√©alisation** = (heures_consommes / heures_vendues) √ó 100
- **Montant reconnu** (ligne) :
  - Si unit√© = "heure" : `heures_metal √ó pu_horaire`
  - Si unit√© = "unit√©" : `delivered_qty √ó pu`
- **Ligne sold√©e** : `delivered_qty >= quantite`
- **T√¢che parapluie** : cr√©√©e automatiquement au premier import de ligne BPU

---

## üêõ Points d'attention

1. **V√©rifier les vues SQL** : `V_BPU_Parapluies_Actifs`, `V_BPU_Lignes_Disponibles`, `V_Affaire_BPU_Suivi`, `V_Affaire_BPU_Livraisons`
2. **Tester les triggers** : cr√©ation automatique de la t√¢che parapluie
3. **V√©rifier les fonctions** : `fn_bpu_on_realisation_terminee`, `fn_bpu_on_realisation_reportee`
4. **Tester le cron** : `cron_bpu_avancement_weekly` (lundi 00:05)
5. **V√©rifier l'API** : toutes les routes doivent retourner les bonnes donn√©es

---

**üéâ Module BPU compl√®tement impl√©ment√© et pr√™t pour les tests !**


---
alwaysApply: true
---
üß≠ PRD ‚Äî Custom Follow-ups Builder (Form/Page Builder interne)
Auteur : Fred Baudry
Version : 1.0
But : Permettre de cr√©er depuis l‚Äôapplication des pages de suivi sur mesure (‚Äúmasques‚Äù), avec champs, r√®gles, workflow, permissions, exports et notifications ‚Äî reli√©s aux entit√©s (Site, Affaire, T√¢che Gantt, Ressource).
________________________________________
1) Objectifs
1.	Cr√©er des masques de saisie (formulaires/pages) sans coder.
2.	D√©finir champs, r√®gles, validations, visibilit√© conditionnelle, √©tats (m√™mes que Remont√©e Site si voulu).
3.	Publier un suivi particulier li√© √† un Site/Affaire/T√¢che.
4.	G√©rer workflows (qui saisit, qui valide, quand), rappels et digest.
5.	Exploiter les donn√©es : tableau, exports, KPI, liaison Gantt/Finance (option).
________________________________________
2) R√¥les & acc√®s
R√¥le	Capacit√©s
Admin / Builder	Cr√©er/√©diter/publier masques, d√©finir permissions, workflows
Planificateur / Resp. Site	Activer un suivi sur un p√©rim√®tre (site/affaire/t√¢che)
Op√©rationnel	Saisir/mettre √† jour les entr√©es autoris√©es
Direction/Contr√¥le	Lecture, reporting, exports
Droits pilot√©s par ton module r√¥les/permissions existant (page + composants).
________________________________________
3) Fonctionnalit√©s
3.1 Cr√©ation de ‚Äúmasques‚Äù (form builder)
‚Ä¢	Champs disponibles : texte, nombre, devise, date/heure, dur√©e, liste, multi-s√©lection, tag, bool√©en, fichier, photo, signature, g√©opoint, lien t√¢che/affaire/site/ressource.
‚Ä¢	Sections & groupes r√©p√©tables (ex. ‚ÄúLignes d‚Äôinspection‚Äù).
‚Ä¢	Logique conditionnelle : afficher/obligatoire selon valeur d‚Äôun autre champ.
‚Ä¢	R√®gles : regex, min/max, bornes de dates, unicit√© par (entit√©, date), fen√™tre horaire (ex. soir uniquement).
‚Ä¢	√âtats : reprendre un set existant (Non lanc√©e / En cours / Termin√©e / Bloqu√©e / Report√©e / Prolong√©e / Suspendue) ou d√©finir un set custom (ex. ‚ÄúValid√©e‚Äù, ‚ÄúContr√¥l√©e‚Äù).
‚Ä¢	Hooks : √† la soumission ou au changement d‚Äô√©tat ‚Üí envoyer mail, ping Teams, mettre √† jour une t√¢che, cr√©er un claim, etc.
‚Ä¢	Templates : enregistrer comme mod√®le (ex. ‚ÄúMaintenance journal‚Äù, ‚ÄúContr√¥le EPI‚Äù, ‚ÄúAudit s√©curit√©‚Äù).
3.2 Publication & rattachement
‚Ä¢	Publier un masque en choisissant la port√©e :
o	par Site, par Affaire, par T√¢che Gantt ou global.
‚Ä¢	Param√®tres d‚Äôinstance :
o	fen√™tre de saisie (heures), fr√©quence (quotidien/hebdo/mensuel/√† l‚Äô√©v√®nement), destinataires des digest et alerts.
‚Ä¢	G√©n√©ration automatique d‚Äôune page d√©di√©e (URL interne) + apparition dans le menu si autoris√©.
3.3 Saisie & validation
‚Ä¢	UI mobile-friendly, offline-tolerant (draft local ‚Üí synchro).
‚Ä¢	Auto-remplissage depuis le contexte (site/affaire/t√¢che, ressources planifi√©es).
‚Ä¢	Pi√®ces jointes (photos, PDF), signature.
‚Ä¢	Workflow en 1 ou 2 √©tapes : saisie ‚Üí validation (resp).
‚Ä¢	Journ√©e √† confirmer (option) : fin de journ√©e le validateur confirme, puis fige dans reporting.
3.4 Notifications & digest
‚Ä¢	Rappels (ex. 17:30 s‚Äôil manque des saisies).
‚Ä¢	Digest p√©riodiques : quotidien/hebdo/mensuel vers mails d√©finis (HTML + PDF en Storage).
‚Ä¢	R√®gles d‚Äôalertes : si champ X hors tol√©rance, si √©tat ‚ÄúBloqu√©‚Äù, si ‚ÄúSuspension ouverte‚Äù, etc.
3.5 Exploitation & int√©grations
‚Ä¢	Tableau des entr√©es, filtres (site, affaire, t√¢che, √©tat, p√©riode).
‚Ä¢	Exports CSV/XLSX/PDF.
‚Ä¢	KPI builder simple : compte par √©tat, % conformit√©, temps m√©tal cumul√© (si champs heure/suspension).
‚Ä¢	Gantt : option pour pousser % avancement ou statut vers une t√¢che li√©e.
‚Ä¢	Base Affaires/Lots : option pour pousser un indicateur (sans imposer la finance si non voulu).
________________________________________
4) Mod√®le de donn√©es (Supabase)
forms (d√©finition de masque)
‚Ä¢	id uuid, name text, description text, version int,
‚Ä¢	schema jsonb (JSON Schema-like des champs/sections/visibilit√©/validations/√©tats),
‚Ä¢	permissions jsonb (qui peut cr√©er/lire/valider/exporter),
‚Ä¢	created_by uuid, created_at timestamptz, published boolean.
form_instances (publication/port√©e)
‚Ä¢	id uuid, form_id uuid,
‚Ä¢	scope_type text (site|affaire|tache|global), scope_id uuid (nullable),
‚Ä¢	schedule jsonb (fen√™tre horaire, fr√©quence, rappels),
‚Ä¢	digest_settings jsonb (p√©riodicit√©, destinataires),
‚Ä¢	is_active boolean, created_by, created_at.
form_entries (donn√©es)
‚Ä¢	id uuid, form_id, instance_id,
‚Ä¢	site_id uuid (nullable), affaire_id uuid (nullable), tache_id uuid (nullable),
‚Ä¢	author uuid, date_jour date (option),
‚Ä¢	state text, data jsonb (payload champs),
‚Ä¢	attachments jsonb[],
‚Ä¢	confirmed boolean default false,
‚Ä¢	created_at, updated_at.
form_entry_history
‚Ä¢	id uuid, entry_id uuid, action text (create|update|confirm|validate),
‚Ä¢	diff jsonb, actor uuid, at timestamptz.
form_notifications
‚Ä¢	traces d‚Äôenvois (rappels/digest/alertes), pour audit.
Index utiles : (form_id, created_at), (scope_type, scope_id), (state), (date_jour).
________________________________________
5) R√®gles m√©tier
‚Ä¢	Un masque publi√© devient en lecture seule c√¥t√© d√©finition (versionn√©).
‚Ä¢	Versioning : modifier un masque ‚Üí nouvelle version, instances futures utilisent V+1 ; les entr√©es existantes restent sur V.
‚Ä¢	Unicit√© optionnelle par (entit√©, date) via r√®gle du masque (ex. une entr√©e par t√¢che/jour).
‚Ä¢	Fen√™tre horaire respect√©e si configur√©e (ex. soir).
‚Ä¢	Confirmation (si activ√©e) fige l‚Äôentr√©e en ‚Äúreporting‚Äù (flag confirmed=true + log).
‚Ä¢	S√©curit√© : permissions du masque + r√¥les globaux (double garde).
________________________________________
6) Acceptation (extraits)
‚Ä¢	Builder permet de cr√©er champs, sections, r√©p√©titions, √©tats, r√®gles conditionnelles.
‚Ä¢	Publication par Site/Affaire/T√¢che op√©rationnelle.
‚Ä¢	Saisie mobile, pi√®ces jointes, validations OK.
‚Ä¢	Rappels et digest configurables et envoy√©s.
‚Ä¢	Confirmation fin de journ√©e (si activ√©e) ‚Üí donn√©es fig√©es.
‚Ä¢	Exports CSV/XLSX/PDF fid√®les.
‚Ä¢	Option push vers Gantt/Affaires fonctionne quand activ√©e.
‚Ä¢	Journal d‚Äôaudit complet (history).
‚Ä¢	Versioning des masques sans casser l‚Äôhistorique.
________________________________________
7) UI / composants
‚Ä¢	FormBuilderStudio (drag-n-drop champs, r√®gles, √©tats, aper√ßu live)
‚Ä¢	FormInstancePublisher (port√©e, fr√©quence, rappels, digest)
‚Ä¢	DynamicForm (renderer JSON ‚Üí UI, offline-draft)
‚Ä¢	EntryList (tableau, filtres, exports)
‚Ä¢	ConfirmEndOfDay (bascule reporting)
‚Ä¢	DigestPreview (aper√ßu mail/PDF)
‚Ä¢	FormPermissionsEditor (droits par r√¥le/page/composant)
________________________________________
8) Stack & notes techniques
‚Ä¢	Renderer bas√© sur JSON Schema + conditions (ex. if/then/else).
‚Ä¢	Validation via Zod au runtime (g√©n√©r√© depuis schema).
‚Ä¢	Storage pour fichiers/photos.
‚Ä¢	SMTP pour mails (rappels/digest/alertes).
‚Ä¢	Realtime : mise √† jour des listes en direct.
‚Ä¢	Perf : pagination serveur, index cibl√©s, compression des pi√®ces jointes.
________________________________________
9) Exemples d‚Äôusages (concrets)
‚Ä¢	Contr√¥le EPI mensuel (site) ‚Üí √©tat ‚ÄúConforme/Non conforme/√Ä remplacer‚Äù, digest mensuel.
‚Ä¢	Journal S√©curit√© quotidien (affaire) ‚Üí blocages HSE, photos, signature du chef.
‚Ä¢	Suivi Sous-traitants hebdo (t√¢che) ‚Üí pr√©sent√©s/planifi√©s, retard, blocage logistique.
‚Ä¢	R√©ception Qualit√© (t√¢che) ‚Üí liste de points (r√©p√©table), statut, PV en pi√®ce jointe.


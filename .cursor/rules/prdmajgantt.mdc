---
alwaysApply: true
---
PRD â€” Tuile â€œTÃ¢ches 4 niveauxâ€ (v2) â€” drag&drop, liens, masques, gÃ©nÃ©ration Affaires
0) Quâ€™est-ce qui change vs version prÃ©cÃ©dente

Profondeur hiÃ©rarchique : 4 niveaux max (0..3). Blocage Ã  lâ€™indentation > niveau 3.

Option v2 activÃ©e :

DÃ©tection de sur-affectation (par ressource, pÃ©riode, calendrier) avec alertes.

Notifications / Webhooks : passage â€œÃ€ planifier â†’ PlanifiÃ©â€, â€œLiens modifiÃ©sâ€, â€œConflits dÃ©tectÃ©sâ€.

Masques de tÃ¢ches (templates) : insertion rapide dâ€™un pattern de tÃ¢ches/sous-tÃ¢ches prÃ©configurÃ©.

GÃ©nÃ©ration depuis Affaire : auto-crÃ©ation des Lots & Jalon(s) Ã  partir du dÃ©coupage Affaires.

1) Masques de tÃ¢ches (Templates)
1.1 ModÃ¨le de donnÃ©es

Table TaskTemplates

id (uuid), name (text), description (text), max_level (int â‰¤ 4), default_calendar_id (ref|null).

structure (jsonb) : liste hiÃ©rarchique statique (titres, durÃ©es, offsets, liens internes).

{
  "items":[
    {"title":"Lot type â€” PrÃ©pa","level":0,"duration_days":3,"offset_days":0},
    {"title":"Ã‰tude","level":1,"duration_days":1,"offset_days":0,"link_from_prev":"FS"},
    {"title":"Appro","level":1,"duration_days":2,"offset_days":1,"link_from_prev":"FS"}
  ]
}


defaults (jsonb) : status, assignees (optionnel), work_days_only (bool).

Table TaskTemplateMappings (optionnelle)

Permet de mapper les champs de lâ€™Affaire (ex. LotName, Acheteur, DateCommande) vers des champs de tÃ¢ches lors dâ€™une insertion de masque conditionnelle.

1.2 UX

Bouton â€œAppliquer un masqueâ€¦â€ â‡’ modal :

SÃ©lecteur de masque ; options : date de dÃ©part, appliquer work days only, assignations par dÃ©faut.

AperÃ§u hiÃ©rarchique avant insertion.

Choix du parent oÃ¹ insÃ©rer (racine ou tÃ¢che sÃ©lectionnÃ©e).

RÃ¨gles :

On respecte la limite 4 niveaux (si le masque dÃ©passe, on bloque avec message).

Offsets & liens internes du masque sont conservÃ©s ; recalcul selon calendrier courant.

1.3 API

GET /task-templates

POST /task-templates (admin)

POST /tasks/apply-template body: { template_id, parent_id, start_date, affaire_id?, site_id?, options{} }

2) GÃ©nÃ©ration automatique depuis la table Affaires
2.1 HypothÃ¨se de structure Affaires

Table Affaires (dÃ©jÃ  existante)

affaire_id, site_id, decoupage_lots (jsonb array), date_debut_prevue, date_fin_prevue, statut, etc.

Exemple decoupage_lots :

[
  {"lot_code":"L1","label":"PrÃ©pa","type":"LOT","duration_days":3,"links":[{"to":"L2","type":"FS"}]},
  {"lot_code":"L2","label":"RÃ©alisation","type":"LOT","duration_days":6},
  {"lot_code":"FCT","label":"Facturation","type":"JALON","trigger":"100% preceding","lag_days":0}
]

2.2 RÃ¨gles de gÃ©nÃ©ration

Bouton â€œGÃ©nÃ©rer depuis Affaireâ€ â‡’ sÃ©lection de lâ€™Affaire (ou auto si contexte), mapping des champs :

LOTS â‡’ tÃ¢ches niveau 1 sous une tÃ¢che parapluie (niveau 0) â€œ<Affaire â€“ Lot>â€.

type:"JALON" â‡’ tÃ¢che dur=0 j (barre fine) avec liens FF vers les prÃ©cÃ©dents lots, ou trigger â€œ100% precedingâ€.

Applique les liens dÃ©crits dans decoupage_lots.links.

Si lâ€™Affaire contient un â€œLot Financierâ€ â‡’ crÃ©ation de jalon facturation; quand les tÃ¢ches prÃ©cÃ©dentes atteignent 100%, alerte â€œCA facturableâ€ (webhook/notification).

Parent enveloppe (tÃ¢che parapluie) se cale sur min(start enfants) / max(end enfants).

Respect du calendrier (jours ouvrÃ©s si activÃ©).

Idempotence : si on rÃ©gÃ©nÃ¨re, option â€œmettre Ã  jour si existant / crÃ©er doublons / ignorer existantsâ€.

2.3 API

POST /tasks/generate-from-affaire body: { affaire_id, parent_id?, options{ updateMode, createMilestones, calendarId } }

3) HiÃ©rarchie & limites (4 niveaux)

level âˆˆ {0,1,2,3} ; blocage Ã  lâ€™indentation quand level==3.

Suppression parent : choix â€œsupprimer enfantsâ€ ou â€œremonter dâ€™un niveauâ€.

Tri stable via order_index (float); DnD met Ã  jour parent + order_index.

4) Autoscheduling & liens (inchangÃ© + prÃ©cisions)

Types: FS (dÃ©faut), SS, FF, SF + lag_days.

Parent enveloppe auto ; si parent manuellement fixÃ©, proposer â€œrecalcule descendants ? Oui/Nonâ€.

Conflits: dates invalides, cycles de liens â‡’ message + rollback.

5) Option v2 â€” Sur-affectation & Notifications

Sur-affectation : quand Î£(tÃ¢ches actives sur plage) > capacitÃ©_calendrier(ressource) â‡’ badge ğŸ”´ sur ligne + panneau â€œConflits de ressourceâ€.

Notifications (email/push/webhook) :

Passage Ã€ planifier â†’ PlanifiÃ©, Jalon atteint 100%, Lien modifiÃ© impactant plus de N jours, Conflit de ressource.

ParamÃ¨tres : seuils, destinataires, modes (batch quotidien, instantanÃ©).

6) ModÃ¨le de donnÃ©es (delta)

Tasks : level (0..3), template_origin_id (uuid|null), is_milestone (bool), manual (bool), order_index (float).

TaskLinks : type (enum), lag_days (int).

Affaires : decoupage_lots (jsonb), champs â€œLot Financierâ€ si besoin.

TaskTemplates (+ TaskTemplateMappings optionnel).

7) CritÃ¨res dâ€™acceptation (extraits)

Impossible dâ€™indenter au-delÃ  du 4áµ‰ niveau.

â€œAppliquer un masqueâ€¦â€ insÃ¨re la structure annoncÃ©e (titres, offsets, durÃ©es, liens) sans dÃ©passer 4 niveaux.

â€œGÃ©nÃ©rer depuis Affaireâ€ crÃ©e Lots + Jalon de facturation selon decoupage_lots, avec liens et notification CA facturable (si 100% atteint).

DÃ©tection sur-affectation visible en temps rÃ©el sur DnD/resize.

Notifications envoyÃ©es selon rÃ¨gles configurÃ©es.
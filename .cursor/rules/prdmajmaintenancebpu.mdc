---
alwaysApply: true
---
üß≠ PRD ‚Äî Affaires BPU ‚Äúparapluie‚Äù + Saisie Maintenance guid√©e

Version : 1.1
Modules impact√©s : Affaires, Maintenance (journal 14‚Äì18), Gantt, KPI
R√®gle cl√© : si type_affaire = 'BPU' alors :

Gantt cr√©e une t√¢che parapluie (nom = Contrat {Nom Affaire} ‚Äî D√©charge batterie, par ex.).

Dans Maintenance, on voit la t√¢che parapluie et on clique dessus pour cr√©er une r√©alisation :

affaire verrouill√©e,

on saisit juste la Tranche (0‚Äì9),

on choisit le Syst√®me √âl√©mentaire depuis la liste BPU de l‚Äôaffaire,

on s√©lectionne Type de maintenance (pr√©rempli si dispo),

√©tat (En cours / Report√©e / Termin√©e / Suspendue / Prolong√©e).

Report√©e ‚áí cause obligatoire, non factur√©e (mais compt√©e dans KPI).

Termin√©e ‚áí actualise le bilan d‚Äôheures et le bilan mon√©taire de l‚Äôaffaire.

1) UX ‚Äî o√π et comment on saisit
1.1 Sur la page Maintenance (14:00‚Äì18:00)

Encart ‚ÄúAffaires BPU actives (site courant)‚Äù
‚Üí cartes Parapluie (une par affaire BPU sur ce site) :
Contrat {Nom Affaire} ‚Äî D√©charge batterie
badges : Capacit√© Z h | Vendu X h | Consomm√© Y h.

Clic sur la carte ‚Üí ouvre Tuile ‚ÄúNouvelle r√©alisation BPU‚Äù :

Affaire : verrouill√©e (non modifiable)

Tranche : obligatoire (0..9)

Syst√®me √âl√©mentaire : liste d√©roulante issue de affaire_bpu_lignes (lignes vendues et non sold√©es)

Type de maintenance : pr√©rempli si la ligne BPU a un libell√© type (sinon libre)

√âtat : En cours / Report√©e / Termin√©e / Suspendue / Prolong√©e

Si Report√©e : Motif obligatoire, aucune mon√©tisation

Heures : pr√©sence / suspension ‚Üí m√©tal auto (‚â• 0)

Enregistrer (auto-save silencieux √† chaque action)

NB : Tuile = la m√™me UI/animations que tes tuiles Terrain/Maintenance (v1.2.x).

1.2 Dans le Gantt

Une seule barre ‚ÄúParapluie BPU ‚Äì {Affaire}‚Äù couvrant la p√©riode (ex. ann√©e).

Progress auto hebdo (mode r√©gie).

Tooltip : Capacit√© / Vendu / Consomm√© / ‚Ç¨ reconnu / √âcarts.

1.3 Sur la fiche Affaire BPU

Carte ‚ÄúSuivi heures & ‚Ç¨ (BPU)‚Äù :

Capacit√© (ressources √ó 35h/sem √ó nb sem)

Vendu (h) (des lignes BPU ‚Äúvendues‚Äù ‚Üí heures √©quiv.)

Consomm√© (h) (somme heures m√©tal r√©alis√©es)

‚Ç¨ reconnu (lignes BPU livr√©es par r√©alisations termin√©es)

Barres : Consomm√©/Capacit√© et Consomm√©/Vendu

Tableau ‚ÄúR√©alisation BPU‚Äù (journal li√©) : date, tranche, syst√®me √©l√©m., type, √©tat, h m√©tal, code BPU / libell√©, ‚Ç¨ reconnu (si termin√©e), motif (si report√©e).

2) R√®gles de gestion (noyau)
2.1 Cr√©ation de l‚Äôaffaire BPU

CSV BPU obligatoire (d√©j√† act√©).

√Ä la validation :

cr√©er t√¢che parapluie dans planning_taches

initialiser Capacit√© = nb_ressources_ref * heures_semaine_ref * nb_semaines(p√©riode)

par d√©faut nb_ressources_ref=2, heures_semaine_ref=35 (√©ditables).

2.2 R√©alisation (depuis Maintenance)

Affaire verrouill√©e par la carte parapluie.

Tranche (0‚Äì9) obligatoire.

Syst√®me √âl√©mentaire choisi dans la liste des lignes BPU vendues (et non sold√©es) de l‚Äôaffaire.

On associe la r√©alisation √† la ligne BPU (bpu_ligne_id).

√âtats :

Report√©e ‚Üí motif obligatoire, pas de mon√©tisation, visible dans KPI.

Termin√©e ‚Üí

Heures : ajoute heures_metal au Consomm√© (h) de l‚Äôaffaire,

Mon√©taire :

si BPU √† l‚Äôunit√© ‚áí delivered_qty += 1, ‚Ç¨ reconnu += PU (plafonn√© √† la qt√© vendue),

si BPU √† l‚Äôheure ‚áí ‚Ç¨ reconnu += heures_metal √ó PU_h (si fourni),

si √©quivalence heures ‚áí via bpu_heures_equiv (optionnelle).

Marquer la ligne BPU comme partiellement livr√©e / sold√©e (si qt√© atteinte).

Suspendue / Prolong√©e ‚Üí r√®gles heures m√©tal (suspension exclue), KPI impact.

Pas de facturation depuis Maintenance : on reconna√Æt l‚Äôavancement ‚Ç¨ c√¥t√© Affaires, sans √©mettre facture ici.

2.3 Avancement auto

Hebdo (lundi 00:05) : %avancement = min(100, Consomm√©(h)/Capacit√©(h) √ó 100) mis √† jour sur la t√¢che parapluie.

KPI Affaire :

Remplissage = Vendu/Capacit√©

R√©alisation = Consomm√©/Vendu

Reconnu ‚Ç¨ = somme ‚Ç¨ lignes livr√©es

3) Mod√®le de donn√©es (extensions)
affaires (ajouts)

type_affaire ‚àà {BPU, Forfait, Maintenance, Autre}

nb_ressources_ref int (def 2)

heures_semaine_ref numeric (def 35)

periode_debut date / periode_fin date

heures_capacite numeric (vue ou champ)

heures_vendues_total numeric (vue)

heures_consommes_total numeric (vue)

montant_reconnu_total numeric (vue)

affaire_bpu_lignes (compl√©ments)

statut_ligne ‚àà {proposee, vendue, annulee}

code_bpu, libelle, quantite, unite, pu

delivered_qty numeric default 0

delivered_hours numeric default 0

montant_reconnu numeric default 0

(option) pu_horaire numeric

(option) heures_equiv_unitaire numeric

planning_taches

is_parapluie_bpu bool default true

affaire_id fk

maintenance_journal (BPU mode)

affaire_id fk nullable

bpu_ligne_id fk nullable ‚Üê nouveau lien quand la r√©alisation est rattach√©e √† une ligne BPU

tranche int (0..9), systeme_elementaire text, systeme text, type_maintenance text

etat_reel, heures_presence, heures_suspension, heures_metal, motif

Vues

V_Affaire_BPU_Suivi : par affaire ‚Üí Capacit√©, Vendu(h), Consomm√©(h), Reconnu(‚Ç¨), √©carts.

V_Affaire_BPU_Livraisons : journal des r√©alisations termin√©es avec impacts qty/‚Ç¨.

4) Automatisations
√âv√©nement	Fonction	Effet
Cr√©ation affaire BPU	fn_create_bpu_parapluie_task()	Cr√©e barre Gantt + init capacit√©
Import CSV BPU	fn_import_bpu_affaire()	Ins√®re lignes BPU (statut=proposee/vendue)
Passage r√©alisation ‚Üí Termin√©e	fn_bpu_on_realisation_terminee(maintenance_id)	+heures_consommes ; +qty/‚Ç¨ reconnu sur ligne BPU ; maj vues
Passage r√©alisation ‚Üí Report√©e	fn_bpu_on_realisation_reportee(maintenance_id)	log KPI, 0 ‚Ç¨
Recalcule hebdo	cron_bpu_avancement_weekly()	Met √† jour progress barre parapluie
Nightly agr√©gats	fn_agg_bpu_affaire_totaux()	rafra√Æchit affaires / dashboard

S√©curit√©

Emp√™cher la sur-livraison : si delivered_qty >= quantite ‚áí ne plus proposer la ligne dans le s√©lecteur.

5) UI / Composants

BPUTaskCard (Maintenance) : carte parapluie (clic ‚Üí tuile saisie)

BPURealizationTile : tuile Affaire verrouill√©e + Tranche 0..9 + Select Syst√®me √âl√©mentaire (BPU) + Type + √âtat + Heures + Motif si report√©

AffaireBPUOverview : 3 KPI (Capacit√©/Vendu/Consomm√©) + ‚Ç¨ reconnu + 2 barres

BPURealizationsTable : journal des r√©alisations li√©es √† l‚Äôaffaire

6) Crit√®res d‚Äôacceptation

 Si type_affaire=BPU, on voit la t√¢che parapluie dans Maintenance (par site).

 Clic parapluie ‚Üí tuile BPU avec affaire verrouill√©e.

 La liste des Syst√®mes √âl√©mentaires vient des lignes BPU vendues non sold√©es.

 Report√©e : cause requise, ‚Ç¨ reconnu = 0, visible KPI.

 Termin√©e : Consomm√©(h) ‚Üë et ‚Ç¨ reconnu ‚Üë selon la ligne BPU.

 Gantt parapluie : progress auto hebdo et tooltip chiffr√©.

 Aucune sur-livraison possible vs quantite BPU.

 Affaire : cartes KPI coh√©rentes, tableaux exacts.

7) Cas limites & r√®gles fines

Plusieurs affaires BPU actives sur un site : afficher plusieurs cartes ; la tuile ouvre l‚Äôaffaire cliqu√©e.

Ligne BPU sans ‚Äúsyst√®me √©l√©mentaire‚Äù dans le CSV :

autoriser une s√©lection manuelle dans un r√©f√©rentiel, ou

forcer le choix du code BPU puis affecter ‚Äúsyst√®me √©l√©mentaire‚Äù libre.

BPU horaire : si pu_horaire pr√©sent, ‚Ç¨ reconnu = heures_metal √ó pu_horaire (arrondi param√©trable).

Rectificatif : une r√©alisation annul√©e (rollback) d√©cr√©mente qty/‚Ç¨ reconnu et heures consomm√©es.
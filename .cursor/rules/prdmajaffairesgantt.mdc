---
alwaysApply: true
---
ğŸ§­ PRD â€” Module Transition Affaires â†” Gantt & Lots Financiers

Auteur : Fred Baudry
Version : 1.0
Stack : Next.js 15 / Supabase / Tailwind / Recharts / SMTP (alertes automatiques)

1ï¸âƒ£ Objectif gÃ©nÃ©ral

CrÃ©er une jonction fonctionnelle entre les modules Affaires, Gantt, et Facturation, permettant de :

GÃ©rer les lots financiers dâ€™une affaire directement depuis la fiche affaire (ajout / modif / suppression).

Remplacer le statut â€œSoumiseâ€ par â€œÃ€ planifierâ€ Ã  la crÃ©ation ou modification dâ€™une affaire.

Envoyer automatiquement une affaire â€œÃ€ planifierâ€ vers le Gantt, dans une section â€œEn attente de planificationâ€.

Planifier lâ€™affaire Ã  une date donnÃ©e (bouton â€œDÃ©clarer la planificationâ€) â†’ changement de statut en â€œValidÃ©eâ€.

CrÃ©er automatiquement les jalons Ã  partir des lots financiers.

DÃ©clencher une alerte de facturation au ChargÃ© dâ€™Affaires quand un lot est complÃ©tÃ© Ã  100 %.

2ï¸âƒ£ Utilisateurs cibles
RÃ´le	AccÃ¨s	Actions principales
ChargÃ© dâ€™Affaires (CA)	CrÃ©ation et modification des affaires + lots financiers	CrÃ©e ou met Ã  jour les lots, gÃ¨re numÃ©ros de commande
Planificateur	Page Gantt	Voit les affaires â€œÃ€ planifierâ€, dÃ©finit dates de planification
Direction / ContrÃ´le de gestion	Lecture globale	Suit les statuts et les jalons financiers
Administration (option)	Gestion des droits	DÃ©finit qui peut valider une planification
3ï¸âƒ£ FonctionnalitÃ©s principales
ğŸ”¹ 3.1 Modification de la page Affaires
a) Section â€œLots Financiersâ€

Interface de gestion dynamique des lots financiers :

Ajouter / modifier / supprimer un lot.

Champs :

Champ	Type	Description
LibellÃ© du lot	text	Nom ou objet du lot
Montant HT	numeric	Valeur financiÃ¨re
Mode de facturation	enum	Ã  la rÃ©ception / Ã  lâ€™avancement / Ã©chÃ©ancier
Ã‰chÃ©ance prÃ©vue	date	Date cible du jalon
NumÃ©ro de commande client	text	Nouveau champ ajoutÃ©
Commentaire	text	Optionnel

Les lots sont enregistrÃ©s dans la table affaires_lots_financiers et liÃ©s Ã  affaire_id.

b) Statut dâ€™affaire

Remplacement de lâ€™ancien statut â€œSoumiseâ€ â†’ â€œÃ€ planifierâ€.

RÃ¨gle automatique :

Nouvelle affaire = statut = 'A_planifier'.

Modification dâ€™affaire sans tÃ¢che planifiÃ©e = A_planifier.

ğŸ”¹ 3.2 Passage automatique vers le Gantt

Toute affaire avec statut = 'A_planifier' est visible sur la page Gantt dans un bloc â€œEn attente de planificationâ€.

Ce bloc liste :

Nom de lâ€™affaire, site, responsable, date prÃ©visionnelle de dÃ©but/fin, type (BPU / Forfait), nombre de lots financiers.

Bouton â€œDÃ©clarer la planificationâ€.

ğŸ”¹ 3.3 DÃ©claration de planification

Clic sur le bouton â€œDÃ©clarer la planificationâ€ â†’ ouvre une modale :

Champs : Date dÃ©but / Date fin / Responsable planification.

Bouton â€œValiderâ€.

Actions automatiques :

Lâ€™affaire quitte le bloc â€œEn attenteâ€.

CrÃ©ation des tÃ¢ches correspondantes dans planning_taches :

soit les tÃ¢ches opÃ©rationnelles (si affaire classique),

soit une tÃ¢che parapluie (si affaire type BPU).

Mise Ã  jour de affaires.statut = 'Validee'.

ğŸ”¹ 3.4 Cas particulier â€” Affaire type BPU

CrÃ©ation automatique dâ€™une tÃ¢che parapluie dans le Gantt :

Nom : Parapluie â€“ [Nom Affaire]

date_debut, date_fin = dates planifiÃ©es

progress auto = heures Maintenance / capacitÃ© prÃ©visionnelle

is_parapluie_bpu = true

Lâ€™affaire passe directement au statut ValidÃ©e (pas de planif manuelle nÃ©cessaire).

ğŸ”¹ 3.5 GÃ©nÃ©ration des Jalons Financiers

Chaque lot financier dâ€™une affaire devient un jalon dans le Gantt :

planning_taches.type = 'jalon'

planning_taches.lot_financier_id = affaires_lots_financiers.id

date_prevue = echeance_prevue

libelle = libelle du lot

montant = montant du lot

numero_commande = numero_commande

requiert_reception = true si mode_facturation = 'a_la_reception'

Ces jalons apparaissent automatiquement sous la barre principale de lâ€™affaire dans le Gantt.

ğŸ”¹ 3.6 DÃ©clencheur de facturation

Lorsque :

un jalon atteint 100 % dâ€™avancement,

et toutes les tÃ¢ches prÃ©cÃ©dentes associÃ©es au lot sont terminÃ©es,

alors une alerte automatique est envoyÃ©e au ChargÃ© dâ€™Affaires :

â€œğŸ’¡ Lot [Nom du lot] terminÃ© â€” facturation possible.â€

Lâ€™alerte apparaÃ®t :

dans la page Affaires (notification interne),

et par mail SMTP (si activÃ©).

4ï¸âƒ£ ModÃ¨le de donnÃ©es (Supabase)
Table affaires_lots_financiers
Champ	Type	Description
id	uuid pk	
affaire_id	uuid fk â†’ affaires	
libelle	text	
montant_ht	numeric	
mode_facturation	text	
echeance_prevue	date	
numero_commande	text	
commentaire	text	
created_at	timestamptz	
updated_at	timestamptz	
Table planning_taches (extrait pertinent)
Champ	Type	Description
id	uuid	
affaire_id	uuid	
lot_financier_id	uuid nullable	
type	text (tache ou jalon)	
is_parapluie_bpu	bool	
date_debut	date	
date_fin_prevue	date	
progress	numeric	
requiert_reception	bool	
statut	text (a_faire, en_cours, terminee)	
5ï¸âƒ£ RÃ¨gles mÃ©tiers
Cas	RÃ¨gle
Affaire crÃ©Ã©e ou modifiÃ©e sans planif	statut = 'A_planifier'
Affaire planifiÃ©e via Gantt	statut = 'Validee'
Affaire type BPU	CrÃ©ation automatique tÃ¢che parapluie
Lot financier	GÃ©nÃ¨re un jalon dans Gantt
Jalon terminÃ© + tÃ¢ches prÃ©cÃ©dentes terminÃ©es	Envoi alerte facturation au CA
Statut affaire mis Ã  jour	via trigger fn_affaire_status_from_gantt()
6ï¸âƒ£ Automatisations & triggers
Nom	Moment	Action
fn_affaire_status_created()	on insert affaires	statut par dÃ©faut = 'A_planifier'
fn_push_to_gantt()	on update statut='A_planifier'	ajoute affaire dans â€œEn attente de planificationâ€
fn_declare_planification()	via UI bouton	crÃ©e tÃ¢ches / jalons / change statut en 'Validee'
fn_create_jalons_from_lots()	on validate planif	crÃ©e 1 jalon par lot
fn_check_jalon_completion()	cron ou trigger sur progress	si 100% + tÃ¢ches prÃ©cÃ©dentes terminÃ©es â†’ alerte CA
fn_alert_facturation_ca()	via SMTP	envoi mail â€œFacturation possibleâ€
7ï¸âƒ£ UI / Composants
Composant	Description
AffaireEditForm	intÃ¨gre section â€œLots Financiersâ€ (CRUD + numÃ©ro commande)
AffaireStatusBadge	affiche statut dynamique (Ã€ planifier / ValidÃ©e / TerminÃ©e)
GanttPendingCard	bloc â€œEn attente de planificationâ€ avec bouton â€œDÃ©clarer planificationâ€
GanttAutoPlanTask	composant crÃ©ation auto tÃ¢che parapluie
JalonAutoCreator	gÃ©nÃ©ration des jalons Ã  partir des lots financiers
CAFactureAlert	notification â€œFacturation possibleâ€
8ï¸âƒ£ CritÃ¨res dâ€™acceptation
ID	CritÃ¨re	Validation
AFF-GNT-01	Statut â€œSoumiseâ€ remplacÃ© par â€œÃ€ planifierâ€	âœ… visible dans UI
AFF-GNT-02	Affaires â€œÃ€ planifierâ€ affichÃ©es dans Gantt	âœ… bloc dÃ©diÃ©
AFF-GNT-03	Bouton â€œDÃ©clarer planificationâ€ crÃ©e tÃ¢che + dates	âœ… testÃ©
AFF-GNT-04	Statut passe â€œValidÃ©eâ€ aprÃ¨s planif	âœ… cohÃ©rent
AFF-GNT-05	Cas BPU â†’ tÃ¢che parapluie auto	âœ… test BPU ok
AFF-GNT-06	Chaque lot = jalon Gantt	âœ… 1 jalon par lot
AFF-GNT-07	Jalon 100 % + tÃ¢ches prÃ©cÃ©dentes OK â†’ Alerte CA	âœ… SMTP et UI ok
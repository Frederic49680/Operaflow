---
alwaysApply: true
---
ğŸ§­ PRD â€” RÃ¨gles du Diagramme de Gantt (Drag, Drop, Resize & Co)

Auteur : Fred Baudry
Version : 1.0
Stack cible : Next.js + React + Tailwind + Supabase + Frappe-Gantt / D3 / custom layer
Objectif : dÃ©finir les rÃ¨gles de manipulation, validation et impact du diagramme de Gantt interactif (drag & drop, resize, reorder, link, calculs) dans le module Planification.

1ï¸âƒ£ Objectif du module Gantt

Offrir une interface graphique permettant de :

CrÃ©er, modifier et rÃ©organiser les tÃ¢ches dâ€™un projet ou dâ€™une affaire,

Ajuster dynamiquement les dates, durÃ©es, liens de dÃ©pendance et ressources,

Mettre Ã  jour en temps rÃ©el les indicateurs de charge, suraffectation, avancement et atterrissage financier.

Lâ€™expÃ©rience doit Ãªtre fluide, cohÃ©rente, et protÃ©gÃ©e contre les incohÃ©rences mÃ©tiers (ex. tÃ¢che avant le dÃ©but dâ€™affaire, ressource dÃ©jÃ  absente, etc.).

2ï¸âƒ£ Types de manipulation autorisÃ©s
Action	Description	Impact
Drag horizontal (dÃ©placement)	DÃ©placer la tÃ¢che sur lâ€™axe temporel	Modifie date_debut_plan et date_fin_plan
Resize (bord gauche/droit)	Ã‰tendre ou rÃ©duire la durÃ©e planifiÃ©e	Recalcule durÃ©e & effort planifiÃ©
Drop vertical (reorder)	RÃ©ordonner au sein dâ€™un lot ou entre lots	Change lot_id, ordre dâ€™affichage
Drag lien (dependence)	CrÃ©er un lien de dÃ©pendance visuelle entre tÃ¢ches	Ajoute une entrÃ©e dependance (FK â†’ tache_precedente_id)
Double-clic / contexte	Ouvre modal dÃ©tail tÃ¢che	CRUD complet (taux, statut, affectations, etc.)
Alt + Drag	Copie de tÃ¢che (duplique, nouvelle ID, mÃªme params)	Insert clone
Ctrl + Drag	Affecte ressource â€œmultiâ€ (via modal rapide)	Insert dans table taches_ressources
Drag groupÃ© (sÃ©lection multiple)	DÃ©place plusieurs tÃ¢ches en mÃªme temps	Maj groupÃ©e dates relatives
3ï¸âƒ£ Contraintes & validations
ğŸ”¹ 3.1 Contraintes temporelles

Une tÃ¢che ne peut commencer avant la date de dÃ©but dâ€™affaire.

Une tÃ¢che ne peut finir aprÃ¨s la date de fin prÃ©vue dâ€™affaire, sauf si affaire = ouverte.

Une tÃ¢che â€œbloquÃ©eâ€ (statut='BloquÃ©e') ne peut pas Ãªtre dÃ©placÃ©e tant que non dÃ©bloquÃ©e.

Si la tÃ¢che a une dÃ©pendance (fin-dÃ©but), la date de dÃ©but ne peut Ãªtre antÃ©rieure Ã  la fin de la tÃ¢che prÃ©cÃ©dente.

Si dÃ©calage forcÃ© â†’ prompt utilisateur :

âš  â€œCette tÃ¢che prÃ©cÃ¨de une dÃ©pendance. Souhaitez-vous dÃ©caler Ã©galement les suivantes ?â€

ğŸ”¹ 3.2 Contraintes hiÃ©rarchiques

DÃ©placement inter-affaires interdit.

DÃ©placement inter-lot autorisÃ© uniquement si mÃªme affaire.

DÃ©placement inter-site interdit (une tÃ¢che = 1 site).

Si tÃ¢che maÃ®tre (lot parent) dÃ©placÃ©e â†’ dÃ©calage de toutes ses sous-tÃ¢ches (option confirmÃ©e).

ğŸ”¹ 3.3 Contraintes ressources

Si ressource affectÃ©e est absente (absences.date_debut <= pÃ©riode <= date_fin) â†’ alerte visuelle rouge.

Si ressource dÃ©jÃ  affectÃ©e >100 % sur la mÃªme pÃ©riode â†’ badge â€œâš  suraffectationâ€.

Si ressource inactive â†’ blocage drop (pas dâ€™affectation possible).

ğŸ”¹ 3.4 Contraintes de statut
Statut	DÃ©placement autorisÃ©	Resize autorisÃ©	Commentaire
Non lancÃ©	âœ…	âœ…	libre
En cours	âš  (si pas dâ€™avancement saisi)	âš 	confirmation requise
TerminÃ©	âŒ	âŒ	verrouillÃ©
BloquÃ©	âŒ	âŒ	non manipulable
ReportÃ© / ProlongÃ©	âœ…	âœ…	alerte recalcul nÃ©cessaire
4ï¸âƒ£ Impact mÃ©tier des actions
Action	Impact direct	Impact secondaire
DÃ©placement horizontal	maj date_debut_plan, date_fin_plan	recalcul date_debut_affaire, date_fin_affaire (si bord extrÃªme)
Resize	maj duree_plan	recalcul effort_plan_h (via ratio h/jour ressource)
Drag vertical	maj lot_id	recalcul budget_lot, pondÃ©ration, avancement_lot
DÃ©pendance ajoutÃ©e	insert dependance_taches	recalcul ordonnancement si auto_schedule=ON
Duplication	insert nouvelle tÃ¢che	recopie affectations si choix â€œdupliquer avec ressourcesâ€
Suppression	archive tÃ¢che	recalcul avancement lot et affaire
Affectation ressource	insert taches_ressources	vÃ©rif compÃ©tence + disponibilitÃ©
Drag groupÃ©	maj relative des dates	recalcul global lot / affaire
5ï¸âƒ£ DonnÃ©es & structure associÃ©e
Table planning_taches
Champ	Type	Note
id	uuid pk	
libelle_tache	text	Nom affichÃ© sur Gantt
lot_id	uuid fk	
affaire_id	uuid fk	
site_id	uuid fk	
date_debut_plan	date	
date_fin_plan	date	
effort_plan_h	numeric	recalcul auto selon durÃ©e
avancement_pct	numeric	0â€“100
statut	text	Enum statut mÃ©tier
dependances	uuid[]	liste tÃ¢ches prÃ©cÃ©dentes
ordre_affichage	int	pour drag vertical
auto_schedule	bool default true	active recalcul auto
created_at	timestamptz	
Table taches_ressources
Champ	Type	Note
id	uuid pk	
tache_id	uuid fk	
ressource_id	uuid fk	
charge_h	numeric	heures prÃ©vues
taux_affectation	numeric	0â€“100 %
competence	text	utilisÃ©e pour adÃ©quation
created_at	timestamptz	
6ï¸âƒ£ Comportements visuels (UX / UI)

Drag preview : ligne guide (magnÃ©tisme aux jours ouvrÃ©s).

Auto-snap : dÃ©but et fin alignÃ©s sur calendrier ouvrÃ© (Ã©vite le week-end).

Color coding :

Bleu clair â†’ tÃ¢che libre

Orange â†’ en conflit (dÃ©pendance ou ressource)

Rouge â†’ violation (hors pÃ©riode affaire / site fermÃ© / ressource absente)

Tooltips dynamiques : affichent durÃ©e, effort, % avancement, suraffectations dÃ©tectÃ©es.

Double-clic : modal â€œModifier tÃ¢cheâ€ (libellÃ©, dates, ressources, statut).

Ctrl+Z / Ctrl+Y : annulation/rÃ©tablissement local (undo/redo client-side).

Auto-save : Ã  chaque release de drag/resize.

7ï¸âƒ£ Moteur de calcul (pseudo logique)
onDragEnd(tache):
  validatePosition()
  if hasDependencyConflict():
      proposeShiftDependants()
  updateDatesInDB()
  recalcEffortPlanifie()
  recalcLotAndAffaireDates()
  if ressourcesLinked:
      updateChargeAndCoverage()
  triggerRealtimeRefresh()

8ï¸âƒ£ Triggers & fonctions Supabase

fn_recalc_tache_effort() : effort_plan_h = durÃ©e * charge_jour / ressource.

fn_update_affaire_dates() : synchronise bornes min/max des tÃ¢ches.

fn_validate_dependencies() : bloque insert si violation temporelle.

fn_recalc_lot_avancement() : somme pondÃ©rÃ©e des tÃ¢ches.

Realtime trigger : broadcast updates â†’ rafraÃ®chit Gantt des autres utilisateurs connectÃ©s.

9ï¸âƒ£ Performances & fiabilitÃ©

Tout drag/drop = maj locale + sync asynchrone DB (optimiste).

DurÃ©e < 150 ms entre â€œdropâ€ et â€œupdate visibleâ€.

Limiter reflows DOM : 60fps cible.

Ã‰viter recalcul complet â†’ recalcul delta (seulement tÃ¢ches modifiÃ©es).

Historiser les modifications (table historique_actions).

ğŸ”Ÿ CritÃ¨res dâ€™acceptation
ID	CritÃ¨re	Validation
GNT-01	Drag horizontal mis Ã  jour en DB	âœ…
GNT-02	Resize recalcul effort planifiÃ©	âœ…
GNT-03	DÃ©pendances respectÃ©es et contrÃ´lÃ©es	âœ…
GNT-04	Blocage inter-affaires effectif	âœ…
GNT-05	Auto-snap jours ouvrÃ©s fonctionnel	âœ…
GNT-06	Undo/Redo opÃ©rationnels	âœ…
GNT-07	Auto-save fiable	âœ…
GNT-08	Realtime synchro multi-utilisateurs	âœ…
GNT-09	Sur-affectations signalÃ©es	âœ…
GNT-10	Recalcul cascade vers lots/affaires cohÃ©rent	âœ…
âš™ï¸ Bonus Ã©volutions (Phase 2)

Mode â€œWhat-ifâ€ (simulation planification sans commit).

Verrouillage collaboratif (tÃ¢che â€œen Ã©dition par Xâ€).

Critical path view (chemin critique).

Zoom temporel adaptatif (jour / semaine / mois).

Planification prÃ©dictive IA (ajustement automatique selon ressources & contraintes).
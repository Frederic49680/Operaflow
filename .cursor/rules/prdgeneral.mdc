---
alwaysApply: true
---
üß≠ PRD G√©n√©ral ‚Äî Syst√®me de Planification & Pilotage (Master)
Auteur : Fred Baudry
Stack cible : Next.js 15 / Supabase (Postgres + Auth + Storage + Functions + Realtime) / Tailwind / Recharts / SMTP
Vision : Un √©cosyst√®me modulaire, fiable et rapide, qui relie Affaires ‚Üí Gantt ‚Üí Terrain ‚Üí Finance (atterrissage) ‚Üí Dashboard, avec RH, Sites, Claims, Interlocuteurs et Maintenance autour.
________________________________________
1) Modules inclus (scope fonctionnel)
1.	Gestion Utilisateurs & Acc√®s (App) ‚Äî Auth, r√¥les, permissions (page & composant), lien d‚Äôactivation 48h, 1 ≥·µâ connexion avec MDP obligatoire.
2.	Sites ‚Äî cl√© hi√©rarchique (actif / en pause / ferm√©), responsable et stats site.
3.	RH Collaborateurs ‚Äî base ressources (actif/inactif, comp√©tences, coordonn√©es), int√©gr√©e √† la planif.
4.	Absences ‚Äî indisponibilit√©s, statut (√† venir / en cours / pass√©e), synchro dispo r√©elle.
5.	Base Affaires (socle m√©tier) ‚Äî identit√©, client/commande, comp√©tence, d√©coupage financier (lots).
6.	Gantt (Planification) ‚Äî t√¢ches reli√©es √† lot/affaire/site, affectations ressources, avancement, suraffectations.
7.	Remont√©e d‚ÄôInformation Site ‚Äî √©tat r√©el, blocage intrajournalier, suspension (hors temps m√©tal), confirmation quotidienne + reporting fig√©.
8.	Maintenance (journal du soir) ‚Äî tranches, syst√®me/√©l√©mentaire/type, m√™mes √©tats, digest mensuel batteries (termin√©es/report√©es).
9.	Interlocuteurs Clients ‚Äî entreprises & contacts, liaison multi-affaires, historique d‚Äôinteractions.
10.	R√©clamations / Claims ‚Äî interne/client/sous-traitant, workflow (ouvert‚Üíclos), montants, pi√®ces, int√©gration dashboard.
11.	Form/Page Builder (suivis particuliers) ‚Äî cr√©ation de masques dynamiques, workflow, digest.
12.	Dashboard Global ‚Äî pilotage multi-r√¥les (N1/N2/N3), filtres globaux, alert center, exports.
________________________________________
2) Ordre d‚Äôex√©cution (mise en ≈ìuvre) ‚Äî Plan de bataille
Objectif : s√©curiser les fondations (auth + mod√®les ma√Ætres), puis monter en valeur par cercles concentriques jusqu‚Äôau dashboard.
Phase 0 ‚Äî Socle & Qualit√© (en parall√®le, d√®s le d√©part)
‚Ä¢	Repo, CI/CD, lint/format (ESLint + Prettier), tests (Vitest/Playwright), feature flags.
‚Ä¢	Design system Tailwind (spacing, couleurs statut, composants shadcn/ui).
‚Ä¢	Observabilit√© : logs serveur, traces, m√©triques (erreurs, latence, requ√™tes lentes).
Phase 1 ‚Äî Acc√®s & R√©f√©rentiels
1.	Gestion Utilisateurs & Acc√®s (Auth, R√¥les, Permissions, Page Access, Component Guards).
2.	Sites (cl√© hi√©rarchique).
3.	RH Collaborateurs (ressources actives, comp√©tences).
4.	Absences (chevauchement interdit, dispo r√©elle).
Gate qualit√© P1 :
‚Ä¢	RBAC √©prouv√© (page + composant), RLS activ√©es.
‚Ä¢	Tables seed√©es (sites, 3‚Äì5 ressources, 2‚Äì3 absences).
‚Ä¢	Temps page /admin/users < 2 s, /sites < 2 s.
Phase 2 ‚Äî Affaires & Finance (socle)
5.	Base Affaires (client/commande, lots financiers).
o	Statuts : Brouillon ‚Üí Soumise ‚Üí Valid√©e (visible planif).
o	Import/Export Excel.
Gate qualit√© P2 :
‚Ä¢	Code affaire unique, rattachement site & responsable valid√©s.
‚Ä¢	CRUD + import/export OK.
Phase 3 ‚Äî Planification
6.	Gantt (Planification & Affectations)
o	T√¢ches reli√©es √† lots (pour atterrissage) et affaires/sites.
o	Affectations ressources filtr√©es (actif, comp√©tences, absences).
o	D√©tection suraffectation (barres >100%).
o	Avancement % + dates r√©elles ‚Üí agr√©gation lots ‚Üí affaires.
Gate qualit√© P3 :
‚Ä¢	CRUD drag/drop stable, perf < 150 ms par update.
‚Ä¢	Recalcules idempotents (lots/affaire) via functions.
Phase 4 ‚Äî Terrain & Reporting
7.	Remont√©e Site
o	1 remont√©e/jour/t√¢che, +1 blocage intrajournalier (motif).
o	Suspension (intervalle hors m√©tal).
o	Confirmation quotidienne ‚Üí copie reporting fig√©.
8.	Maintenance (journal du soir)
o	Saisie en fen√™tre soir (17‚Äì20h), m√™mes √©tats.
o	Batteries + digest mensuel (termin√©es/report√©es).
Gate qualit√© P4 :
‚Ä¢	Heures m√©tal = pr√©sence ‚Äì suspensions (‚â•0).
‚Ä¢	Rappels 17h30, cron digest mensuel OK.
Phase 5 ‚Äî Relations externes
9.	Interlocuteurs Clients (entreprises+contacts, liaisons affaire, r√¥les).
10.	R√©clamations / Claims (workflow, montants, pi√®ces, notifications).
Gate qualit√© P5 :
‚Ä¢	Claim client impossible sans interlocuteur li√©.
‚Ä¢	PDF/mail transmission client g√©n√©r√© correctement.
Phase 6 ‚Äî Suivis particuliers & Dashboard
11.	Form/Page Builder (masques dynamiques, workflow, digest).
12.	Dashboard Global (vues agr√©g√©es + alert center, filtres synchronis√©s).
Gate qualit√© P6 :
‚Ä¢	Vues V_Dashboard_* rafra√Æchies √† 06:00, cartes < 2‚Äì3 s.
‚Ä¢	Exports PDF/Excel corrects, filtres globaux synchronis√©s.
________________________________________
3) Ordre d‚Äôinjection SQL (migrations)
1.	sites ‚Üí ressources (avec site_id)
2.	absences
3.	clients ‚Üí interlocuteurs
4.	affaires ‚Üí affaires_lots
5.	planning_taches ‚Üí taches_ressources
6.	remontee_site ‚Üí tache_suspensions ‚Üí remontee_site_reporting
7.	maintenance_batteries ‚Üí maintenance_journal ‚Üí maintenance_monthly_digest
8.	affaires_interlocuteurs ‚Üí interactions_client
9.	claims ‚Üí claim_history ‚Üí claim_comments
10.	forms ‚Üí form_instances ‚Üí form_entries ‚Üí form_entry_history ‚Üí form_notifications
11.	historique_actions
12.	Vues V_Dashboard_* + Functions (agr√©gations & crons)
13.	Auth & Admin : app_users, roles, permissions, role_permissions, user_roles, page_access_rules, component_flags, user_tokens, audit_log
14.	RLS & policies (apr√®s data-model).
Ajoute index partiels/GIN au fil de l‚Äôeau (notamment competences[], data jsonb, uniques partiels de remont√©e).
________________________________________
4) Flux de donn√©es (haut niveau)
Affaires (lots) ‚Üí Gantt (t√¢ches) ‚Üí Remont√©es (statut, %)
       ‚Üò                           ‚Üò
       Finance (atterrissage)       Reporting fig√© (jour)
        ‚Üò                             ‚Üò
         Dashboard (Affaires)         Dashboard (Terrain/Maintenance)
‚Ä¢	Ressources & Absences influent sur le pool d‚Äôaffectation et la couverture.
‚Ä¢	Interlocuteurs alimentent claims et mails.
‚Ä¢	Builder peut pousser des √©tats vers t√¢che/affaire si activ√©.
________________________________________
5) Non-fonctionnel ‚Äî Qualit√© attendue
Performance
‚Ä¢	TTFP < 1,5 s, TTI < 3 s sur r√©seau normal.
‚Ä¢	Requ√™tes pagin√©es, index sur FK + colonnes de filtre, vues mat√©rialis√©es si besoin.
‚Ä¢	Pas > 150 ms pour op√©rations Gantt courantes (drag/rescale/update).
Fiabilit√© & Int√©grit√©
‚Ä¢	Triggers idempotents pour agr√©gations (t√¢che ‚Üí lot ‚Üí affaire).
‚Ä¢	Unicit√© partielle des remont√©es (hors is_block_event=true).
‚Ä¢	Tests d‚Äôint√©gration pour chevauchement absences, suspensions.
S√©curit√©
‚Ä¢	RLS activ√© par d√©faut.
‚Ä¢	RBAC page & composant, scopes par site.
‚Ä¢	Lien activation 48h, reset 1h, 2FA optionnelle (obligatoire Admin/Direction).
‚Ä¢	Journal d‚Äôaudit sur actions sensibles.
UX
‚Ä¢	Composants coh√©rents (shadcn), codes couleur statut standardis√©s.
‚Ä¢	Autosave dans formulaires longues (Gantt/Remont√©es).
‚Ä¢	Mobile-friendly pour terrain.
Observabilit√©
‚Ä¢	Logs fonctionnels (claims, digest, √©checs mails).
‚Ä¢	Crons monitor√©s (digest maintenance mensuel, refresh dashboard).
‚Ä¢	Alertes en cas d‚Äôerreur de trigger/cron.
Donn√©es & Export
‚Ä¢	Imports/exports Excel (affaires, RH).
‚Ä¢	PDFs archiv√©s (claims transmis, digests).
‚Ä¢	Horodatage TZ Europe/Paris partout.
________________________________________
6) Jeux de donn√©es seed (ordre conseill√©)
1.	R√¥les & permissions (Admin, Planificateur, CA, Resp Site, RH, Maintenance, Direction).
2.	Utilisateurs (admin initial + 3 profils de test, mapping r√¥les).
3.	Sites (2‚Äì3), Ressources (8‚Äì12, comp√©tences vari√©es).
4.	Absences (2‚Äì3 cas pour test dispo).
5.	Clients / Interlocuteurs (au moins 1 client, 2 contacts).
6.	Affaires (2) + Lots (2‚Äì3 par affaire).
7.	T√¢ches Gantt (8‚Äì12) reli√©es aux lots.
8.	Remont√©es (sur 2 jours, avec 1 blocage & 1 suspension).
9.	Maintenance (3 lignes + 1 batterie).
10.	Claims (2 : interne & client).
________________________________________
7) Crit√®res d‚Äôacceptation globaux
‚Ä¢	Auth compl√®te (invitation 48h, 1 ≥·µâ connexion MDP, RBAC, RLS).
‚Ä¢	Sites/RH/Absences op√©rationnels et impactant la couverture planif.
‚Ä¢	Affaires valid√©es ‚Üí visibles Planif ; lots reli√©s aux t√¢ches.
‚Ä¢	Gantt CRUD performant ; suraffectations d√©tect√©es.
‚Ä¢	Remont√©e Site : r√®gles (blocage/suspension/confirmation/reporting) respect√©es.
‚Ä¢	Maintenance : fen√™tre soir, digest mensuel batteries.
‚Ä¢	Interlocuteurs ‚Üî Affaires ; Claims workflow + mails.
‚Ä¢	Builder : masque simple publi√© & saisi (POC).
‚Ä¢	Dashboard : filtres globaux + alert center + exports.
‚Ä¢	Observabilit√© & crons green.
________________________________________
8) Livrables UI (par module)
‚Ä¢	/admin/users, /admin/roles, /admin/access
‚Ä¢	/sites, /rh/collaborateurs, /rh/absences
‚Ä¢	/affaires (+ modal lots), /gantt
‚Ä¢	/terrain/remontee (liste jour + confirmation), /maintenance
‚Ä¢	/clients, /interlocuteurs, /claims
‚Ä¢	/builder (studio + instances + saisie)
‚Ä¢	/dashboard
________________________________________
9) Notes d‚Äôimpl√© fut√©es (√©viter les pi√®ges)
‚Ä¢	Constraintes d‚Äôabord, UI ensuite : pose les triggers/CK uniques/partial index avant de brancher la saisie.
‚Ä¢	Agr√©gations : calcule c√¥t√© DB (functions) plut√¥t que c√¥t√© client (coh√©rence).
‚Ä¢	Enums vs CHECK : garde CHECK au d√©but, passe en ENUM quand le vocabulaire est gel√©.
‚Ä¢	Gantt : commence avec Frappe-Gantt (simple), basculable D3 custom si bes


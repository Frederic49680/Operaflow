---
alwaysApply: true
---
ğŸ§­ PRD â€” Maintenance v1.2.4

(journal 14hâ€“18h, tuiles, Tranche=0..9, SystÃ¨me Ã‰lÃ©mentaire autonome, pas de confirmation du jour, reporting ciblÃ© â€œBatterieâ€)

Auteur : Fred Baudry
Stack : Next.js 15 / Supabase / Tailwind / Recharts / SMTP / Framer Motion
RÃ¨gle clÃ© : Saisie 14:00â€“18:00 ; mÃªmes Ã©tats que RemontÃ©e Site ; pas de BPU ici.

1) Objectif

Saisir lâ€™activitÃ© maintenance lâ€™aprÃ¨s-midi via tuiles, avec Ã©tats mÃ©tier, blocage intra-jour, suspension (hors â€œmÃ©talâ€), et un reporting mensuel opÃ©rationnel centrÃ© sur :

totaux par Ã©tat,

total dâ€™heures mÃ©tal,

liste des activitÃ©s dont le systÃ¨me contient â€œBatterieâ€.
(Pas de â€œtop trancheâ€.)

2) DÃ©finitions

Tranche : index de point 0..9 (obligatoire).

SystÃ¨me Ã‰lÃ©mentaire : identifiant technique autonome (ex. LAA001BT, obligatoire).

SystÃ¨me (domaine) : texte libre optionnel (Ã‰lec / IEG / CVC, etc.).

3) FonctionnalitÃ©s
3.1 Journal (fenÃªtre 14:00â€“18:00)

Par ligne :

tranche (0..9)

systeme_elementaire (obligatoire)

systeme (optionnel)

type_maintenance (texte libre : DÃ©charge semestriel / ContrÃ´le / Correctifâ€¦)

etat_reel : Non lancÃ©e / En cours / TerminÃ©e / ProlongÃ©e / ReportÃ©e / Suspendue

motif (requis si Suspendue)

description

heures_presence, heures_suspension â†’ heures_metal = max(0, prÃ©sence â€“ suspension)

Raccourcis : picker tranche 0..9, autocomplete systÃ¨me Ã©lÃ©mentaire, duplication.

3.2 Blocage intrajournalier & Suspension

Blocage intra-jour : autorise une 2áµ‰ ligne (is_block_event=true, motif requis).

Suspension : retirÃ©e du â€œmÃ©talâ€.

3.3 Confirmation du jour

SupprimÃ© : on saisit le rÃ©el directement. Aucune Ã©tape de confirmation.

3.4 Reporting mensuel (validÃ©)

Le dernier jour du mois Ã  18:30 (Europe/Paris), envoi dâ€™un mail de synthÃ¨se par site avec :

Totaux par Ã©tat (TerminÃ©es / ReportÃ©es / ProlongÃ©es / Suspendues / En cours / Non lancÃ©es),

Total heures mÃ©tal,

Liste dÃ©taillÃ©e des activitÃ©s dont systeme contient â€œBatterieâ€ (filtre ILIKE '%batterie%').

CSV joint : date, site, tranche, systeme_elementaire, systeme, type_maintenance, etat_reel, heures_presence, heures_suspension, heures_metal, description.

4) ModÃ¨le de donnÃ©es (Supabase)

Table maintenance_journal

Champ	Type	RÃ¨gles
id	uuid pk	
site_id	uuid fk â†’ sites	
date_jour	date	
tranche	int	0..9, NOT NULL
systeme_elementaire	text	NOT NULL
systeme	text	optionnel
type_maintenance	text	libre
etat_reel	text	Non_lancee / En_cours / Termine / Prolongee / Reportee / Suspendue
motif	text	requis si Suspendue
description	text	
heures_presence	numeric	â‰¥ 0
heures_suspension	numeric	â‰¥ 0
heures_metal	numeric	GREATEST(0, presence - suspension)
is_block_event	bool	
created_by	uuid	
created_at	timestamptz	

Diff vs v1.2.3 : etat_confirme supprimÃ© (plus de confirmation du jour).

Table maintenance_monthly_summary (ou garde maintenance_monthly_digest)

Champ	Type	Description
id	uuid pk	
site_id	uuid	
periode_mois	date	1er du mois
destinataires	text[]	emails
kpi	jsonb	{ terminees, reporteÃ©s, prolongees, suspendues, en_cours, non_lancees, heures_metal }
details	jsonb	{ batterie_list: [ {date, tranche, systeme, systeme_elementaire, type, etat, heures_metal, description} ] }
csv_url	text	lien export
sent_at	timestamptz	
5) Automatisations
TÃ¢che	Quand	DÃ©tail
Restriction saisie	en temps rÃ©el	UI/guard 14:00â€“18:00 (Resp peut outrepasser si tu le souhaites)
RÃ©sumÃ© mensuel	J-dernier 18:30	Mail + CSV. Le backend filtre systeme ILIKE '%batterie%' pour la liste dÃ©diÃ©e
Refresh vues/KPI	nightly	Mise Ã  jour des agrÃ©gats

(Le reminder 18:05 saute puisquâ€™on a supprimÃ© la confirmation.)

6) UI / Tuiles

Tuile = carte avec : Tranche (0..9), SystÃ¨me Ã©lÃ©m., SystÃ¨me (si rempli), Type, Ã‰tats + boutons, Heures (prÃ©sence/suspension/mÃ©tal), Motif (si Suspendue).

Actions :

Ã€ rÃ©aliser â†’ [Lancer] [Reporter]

En cours â†’ [Terminer] [Suspendre] [Prolonger]

Suspendue â†’ [Reprendre] [Reporter]

ReportÃ©e â†’ [Relancer] [Terminer]

ProlongÃ©e â†’ [Terminer] [Suspendre]

TerminÃ©e â†’ rÃ©sumÃ© (mÃ©tal total)

Auto-save silencieux + toast, animations douces (glow/check/fade).

7) KPI & Vues

KPI mensuels : rÃ©partition par Ã©tat, heures mÃ©tal.

Vues/exports filtrables par : site, mois, tranche (0..9), systeme_elementaire, systeme, Ã©tat.

Extraction â€œBatterieâ€ : vue dÃ©diÃ©e listant toutes les lignes dont systeme ILIKE '%batterie%' (mÃªmes colonnes que CSV).

8) CritÃ¨res dâ€™acceptation

 Saisie 14:00â€“18:00 stricte (interface verrouillÃ©e hors plage).

 Tranche 0..9 et SystÃ¨me Ã‰lÃ©mentaire obligatoires.

 Ã‰tats & transitions conformes (mÃªmes que RemontÃ©e Site).

 Heures mÃ©tal correctement calculÃ©es (â‰¥ 0).

 Aucune confirmation du jour requise (3.3 supprimÃ©).

 Mail mensuel contient : totaux, heures mÃ©tal, liste filtrÃ©e â€œBatterieâ€.

 CSV joint conforme.

9) Migration rapide
-- 1) Supprimer le champ de confirmation sâ€™il existe
ALTER TABLE maintenance_journal
  DROP COLUMN IF EXISTS etat_confirme;

-- 2) Sâ€™assurer que tranche et systeme_elementaire sont lÃ  et not null
ALTER TABLE maintenance_journal
  ALTER COLUMN tranche SET NOT NULL,
  ADD COLUMN IF NOT EXISTS systeme_elementaire text;

-- 3) Option : ajouter la table de rÃ©sumÃ© ou conserver lâ€™existante
-- (aucun changement obligatoire cÃ´tÃ© rÃ©sumÃ© si tu gardes maintenance_monthly_digest ; tu adaptes juste le contenu gÃ©nÃ©rÃ©)

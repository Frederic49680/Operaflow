---
alwaysApply: true
---
ğŸ§­ PRD â€” Module Maintenance (journal du soir + reporting mensuel â€œbatterieâ€)
Auteur : Fred Baudry
Version : 1.1
Stack : Next.js 15 / Supabase / Tailwind / SMTP (mail), Recharts (KPI)
RÃ¨gle clÃ© : saisie le soir uniquement ; mÃªmes Ã©tats que la RemontÃ©e Site ; pas de dÃ©penses.
________________________________________
1) Objectif
â€¢	Permettre aux Ã©quipes Maintenance de journaliser chaque soir leurs interventions (par tranches horaires, systÃ¨me, Ã©lÃ©mentaire, type de maintenance).
â€¢	Utiliser les mÃªmes Ã©tats que le module RemontÃ©e Site (Non lancÃ©e, En cours, TerminÃ©e, BloquÃ©e, ReportÃ©e, ProlongÃ©e, Suspendue).
â€¢	GÃ©rer blocage intrajournalier (2áµ‰ saisie autorisÃ©e le mÃªme jour).
â€¢	GÃ©rer la suspension (exclue du temps â€œmÃ©talâ€).
â€¢	En fin de mois, Ã©mettre automatiquement une liste vers le responsable des activitÃ©s â€œbatterieâ€ terminÃ©es et reportÃ©es.
â€œBatterieâ€ = groupe dâ€™activitÃ©s de maintenance (pÃ©riode, systÃ¨me ou campagne). On peut taguer chaque ligne/journal avec une batterie pour le reporting mensuel.
________________________________________
2) Utilisateurs cibles
RÃ´le	AccÃ¨s	Actions
Technicien Maintenance	Saisie soir	CrÃ©e les lignes dâ€™intervention
Resp. Maintenance	Saisie + validation	Relit et valide la journÃ©e, paramÃ¨tre les batteries
ChargÃ© dâ€™Affaires	Lecture	ReÃ§oit le bilan mensuel (terminÃ©es / reportÃ©es)
Planificateur / Direction	Lecture	Historique + KPI
________________________________________
3) FonctionnalitÃ©s
3.1 Journal du soir (fenÃªtre 17:00â€“20:00, paramÃ©trable)
Pour chaque ligne :
â€¢	Tranche horaire (dÃ©but â†’ fin)
â€¢	SystÃ¨me (Ã©lec, CVC, sÃ»retÃ©, etc.)
â€¢	Ã‰lÃ©mentaire (Ã©quipement/point : TGBT, CTA-2, Pompe P3â€¦)
â€¢	Type de maintenance : PrÃ©ventive / Corrective / ContrÃ´le / AmÃ©lioration
â€¢	Ã‰tat rÃ©el : Non lancÃ©e / En cours / TerminÃ©e / BloquÃ©e / ReportÃ©e / ProlongÃ©e / Suspendue
â€¢	Motif (obligatoire si BloquÃ©e/Suspendue)
â€¢	Description courte
â€¢	Batterie (sÃ©lecteur) â€” optionnel mais recommandÃ© pour le bilan mensuel
â€¢	Heures prÃ©sence + heures suspension â‡’ heures mÃ©tal (= prÃ©sence â€“ suspension)
Raccourcis : duplication de ligne, listes rÃ©centes de systÃ¨mes/Ã©lÃ©mentaires.
3.2 Blocage intrajournalier & Suspension
â€¢	Blocage intrajournalier : autorise une 2áµ‰ ligne le mÃªme jour (flag is_block_event=true, motif obligatoire).
â€¢	Suspension : exclut la durÃ©e du temps mÃ©tal ; peut Ãªtre â€œouverteâ€ (clÃ´turÃ©e Ã  la reprise).
3.3 Ã‰tat du jour & confirmation
â€¢	Vue â€œÃ€ confirmerâ€ chaque soir (lignes du jour non confirmÃ©es).
â€¢	Bouton â€œConfirmer la journÃ©eâ€ â†’ fige les lignes (journal dâ€™audit).
â€¢	Les heures mÃ©tal mises Ã  jour servent aux KPI (pas de finances ici).
3.4 Reporting mensuel â€œBatterieâ€
â€¢	Dernier jour du mois Ã  18:30 (Europe/Paris) : gÃ©nÃ©ration dâ€™un mail automatique au Responsable (et CA en copie si souhaitÃ©) listant :
o	Batteries du mois avec statut :
ï‚§	TerminÃ©es (toutes lignes associÃ©es en Ã©tat â€œTerminÃ©eâ€),
ï‚§	ReportÃ©es (au moins une ligne â€œReportÃ©eâ€ ou â€œProlongÃ©eâ€, et aucune clÃ´ture complÃ¨te),
o	DÃ©tails par batterie : SystÃ¨me, Ã‰lÃ©mentaire, Nb de lignes, % â€œTerminÃ©eâ€, % â€œReportÃ©eâ€, commentaires.
â€¢	PossibilitÃ© dâ€™Ã©mettre manuellement (â€œEnvoyer le bilan mensuel maintenantâ€).
________________________________________
4) ModÃ¨le de donnÃ©es (Supabase)
Table maintenance_journal
Champ	Type	Description
id	uuid	PK
site_id	uuid	FK â†’ sites
date_jour	date	Jour concernÃ©
tranche_debut	timestamptz	DÃ©but
tranche_fin	timestamptz	Fin
systeme	text	Domaine
elementaire	text	Ã‰quipement/point
type_maintenance	text	PrÃ©ventive/Corrective/ContrÃ´le/AmÃ©lioration
etat_reel	text	Non lancÃ©e / En cours / TerminÃ©e / BloquÃ©e / ReportÃ©e / ProlongÃ©e / Suspendue
motif	text	Requis si BloquÃ©e/Suspendue
description	text	Bref rÃ©sumÃ©
batterie_id	uuid (nullable)	FK â†’ maintenance_batteries.id
heures_presence	numeric	h
heures_suspension	numeric	h (exclues mÃ©tal)
heures_metal	numeric	h = prÃ©sence â€“ suspension
is_block_event	bool	true si Ã©vÃ©nement blocage
etat_confirme	bool	true aprÃ¨s validation du soir
created_by	uuid	Auteur
created_at	timestamptz	Horodatage
Contraintes
â€¢	UnicitÃ© journaliÃ¨re par tÃ¢che non applicable ici (on parle dâ€™interventions libres).
â€¢	FenÃªtre horaire : crÃ©ation/Ã©dition permises 17:00â€“20:00 (sauf rÃ´le Resp qui peut corriger H+1).
â€¢	heures_metal >= 0, tranche_fin > tranche_debut.
Table maintenance_batteries
Champ	Type	Description
id	uuid	PK
site_id	uuid	FK â†’ sites
libelle	text	Nom de la batterie (ex. â€œCampagne CTA T2 2025-07â€)
periode_mois	date	Mois de rÃ©fÃ©rence (ex. 2025-10-01)
responsable_id	uuid	Qui recevra le bilan
commentaire	text	Notes
created_by	uuid	Auteur
created_at	timestamptz	
Table maintenance_monthly_digest
(trace dâ€™envoi mensuel)
Champ	Type	Description
id	uuid	PK
site_id	uuid	Site
periode_mois	date	1er du mois (pivot)
destinataires	text[]	Emails envoyÃ©s
nb_batteries_terminees	int	Compte
nb_batteries_reportees	int	Compte
details	jsonb	RÃ©sumÃ© batteries (id, libelle, % terminÃ©e/reportÃ©e)
sent_at	timestamptz	Date/heure envoi
________________________________________
5) RÃ¨gles mÃ©tier
â€¢	Saisie soir uniquement (17:00â€“20:00), sinon lecture seule (sauf Resp H+1).
â€¢	Blocage intrajournalier : 2áµ‰ ligne autorisÃ©e (motif requis).
â€¢	Suspension : exclue du temps mÃ©tal.
â€¢	Batterie :
o	une ligne peut (devrait idÃ©alement) Ãªtre rattachÃ©e Ã  une batterie du mois,
o	TerminÃ©e = toutes les lignes rattachÃ©es sur la pÃ©riode sont â€œTerminÃ©eâ€,
o	ReportÃ©e = au moins une ligne non terminÃ©e (ReportÃ©e/ProlongÃ©e) au dernier jour du mois.
â€¢	Digest mensuel : un seul envoi par site et par mois (rejouable manuellement si besoin).
________________________________________
6) Envoi mensuel â€” contenu du mail
Objet : [Maintenance][{SITE}][{AAAA-MM}] Bilan â€œbatteriesâ€ â€” terminÃ©es & reportÃ©es
Corps :
â€¢	En-tÃªte : Site, Mois, Responsable, Date dâ€™envoi.
â€¢	SynthÃ¨se : nb batteries terminÃ©es / reportÃ©es.
â€¢	Tableau :
o	Batterie | % TerminÃ©e | % ReportÃ©e | SystÃ¨mes/Ã‰lÃ©mentaires clÃ©s | Commentaires
â€¢	Lien â€œVoir le dÃ©tail dans lâ€™appâ€.
Plan dâ€™envoi : dernier jour du mois Ã  18:30 (Europe/Paris).
Destinataires : Responsable (rÃ©f. maintenance_batteries.responsable_id â†’ email), CA en CC (option).
________________________________________
7) KPI & vues
â€¢	KPI mensuels : nb batteries, % terminÃ©es, % reportÃ©es, heures mÃ©tal totales.
â€¢	Vues filtrÃ©es : par site, mois, batterie, Ã©tat.
â€¢	Export CSV/Excel.
________________________________________
8) CritÃ¨res dâ€™acceptation
â€¢	Saisie le soir uniquement, avec fenÃªtre respectÃ©e.
â€¢	Ã‰tats identiques Ã  RemontÃ©e Site, blocage intrajournalier OK (motif).
â€¢	Heures mÃ©tal correctement calculÃ©es (prÃ©sence â€“ suspension, min 0).
â€¢	â€œBatterieâ€ sÃ©lectionnable et gÃ©rÃ©e par mois.
â€¢	Digest mensuel Ã©mis automatiquement (terminÃ©es / reportÃ©es).
â€¢	Mail lisible, rÃ©capitulatif par batterie, un envoi par site et par mois.
â€¢	Historique & export OK, UI responsive.
________________________________________
9) UI / Compos
â€¢	MaintenanceDayForm (saisie lignes + duplication)
â€¢	EveningWindowGuard (verrou temporel)
â€¢	MaintenanceBatterySelector (assigner/Ã©diter batteries)
â€¢	BatteryMonthlyDigestPreview (aperÃ§u fin de mois)
â€¢	MaintenanceHistory (filtres site/mois/batterie/Ã©tat)
________________________________________
10) Automatisation (cron)
â€¢	Quotidien 20:05 : reminder si des lignes non confirmÃ©es.
â€¢	Mensuel J-dernier 18:30 : gÃ©nÃ©ration + envoi digest batteries (terminÃ©es/reportÃ©es) â†’ trace en maintenance_monthly_digest.

